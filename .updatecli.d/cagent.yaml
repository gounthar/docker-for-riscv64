---
# UpdateCLI manifest for tracking cagent versions

name: "Update cagent package version"

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: "gounthar"
      repository: "docker-for-riscv64"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "main"

sources:
  cagentRelease:
    kind: githubrelease
    name: "Get latest cagent release from upstream"
    spec:
      owner: "docker"
      repository: "cagent"
      token: "{{ requiredEnv .github.token }}"
      typefilter:
        latest: true
      versionfilter:
        kind: regex
        pattern: '^v(\d+\.\d+\.\d+)$'
    transformers:
      - trimprefix: "v"

conditions:
  cagentBinaryExists:
    kind: shell
    name: "Verify cagent binary built for RISC-V64"
    disablesourceinput: true
    spec:
      command: |
        set -euo pipefail
        CAGENT_VERSION="{{ source `cagentRelease` }}"

        # Validate gh is available
        if ! command -v gh >/dev/null 2>&1; then
          echo "Error: gh CLI not found"
          exit 1
        fi

        # Check if we already have this version built
        if gh release view "cagent-v${CAGENT_VERSION}-riscv64" --repo gounthar/docker-for-riscv64 --json assets --jq -e '.assets[] | select(.name=="cagent-linux-riscv64")' >/dev/null 2>&1; then
          echo "Release asset for v${CAGENT_VERSION} already exists. No update needed."
          exit 1
        fi

        # If not built yet, check if upstream release exists
        if ! gh release view "v${CAGENT_VERSION}" --repo docker/cagent >/dev/null 2>&1; then
          echo "Upstream release v${CAGENT_VERSION} not found"
          exit 1
        fi

        echo "Condition met: upstream release exists and not yet built"
        exit 0
      environments:
        - name: PATH
        - name: GITHUB_TOKEN
          from: "{{ requiredEnv .github.token }}"

targets:
  updateDebianChangelog:
    name: "Update cagent version in debian-cagent/changelog"
    kind: file
    sourceid: cagentRelease
    spec:
      file: "debian-cagent/changelog"
      matchpattern: '^cagent \(([0-9]+\.[0-9]+\.[0-9]+)-riscv64-1\)'
      replacepattern: 'cagent ({{ source `cagentRelease` }}-riscv64-1)'
    scmid: default

  updateRPMSpec:
    name: "Update cagent version in rpm-cagent/cagent.spec"
    kind: file
    sourceid: cagentRelease
    spec:
      file: "rpm-cagent/cagent.spec"
      matchpattern: '^Version:\s+([0-9]+\.[0-9]+\.[0-9]+)'
      replacepattern: 'Version:        {{ source `cagentRelease` }}'
    scmid: default

  updateCagentSubmodule:
    name: "Update cagent submodule to latest release"
    kind: shell
    sourceid: cagentRelease
    spec:
      command: |
        cd cagent
        git fetch origin --tags
        git checkout "v{{ source `cagentRelease` }}"
        cd ..
        git add cagent
      changedif:
        kind: shell
        spec:
          command: |
            LATEST_TAG="v{{ source `cagentRelease` }}"
            CURRENT_COMMIT=$(git ls-files --stage cagent | awk '{print $2}')
            TARGET_COMMIT=$(git ls-remote https://github.com/docker/cagent.git "refs/tags/${LATEST_TAG}" | cut -f1)
            [ "$CURRENT_COMMIT" != "$TARGET_COMMIT" ]
    scmid: default

actions:
  default:
    kind: github/pullrequest
    scmid: default
    title: 'feat(cagent): update to {{ source `cagentRelease` }}'
    spec:
      labels:
        - cagent
        - automated
        - version-update
      description: |
        ## Automated Update: cagent Package

        This PR updates cagent to the latest upstream release.

        **Changes:**
        - cagent: {{ source `cagentRelease` }}
        - Source: docker/cagent release v{{ source `cagentRelease` }}

        **Updated files:**
        - debian-cagent/changelog
        - rpm-cagent/cagent.spec
        - cagent/ submodule

        **Next steps after merge:**
        The track-cagent-releases workflow will automatically:
        1. Detect the new upstream release
        2. Build RISC-V64 binaries
        3. Create release cagent-v{{ source `cagentRelease` }}-riscv64
        4. Build and publish Debian and RPM packages

        ---
        ðŸ¤– Generated by UpdateCLI
