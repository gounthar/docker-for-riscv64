---
name: "Track cagent Go version requirement"

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: "gounthar"
      repository: "docker-for-riscv64"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "main"
  cagent-upstream:
    kind: "github"
    spec:
      owner: "docker"
      repository: "cagent"
      token: "{{ requiredEnv .github.token }}"
      branch: "main"

sources:
  cagent-go-version:
    name: "Get Go version from cagent go.mod"
    kind: "file"
    scmid: "cagent-upstream"
    spec:
      file: "go.mod"
      # Support both X.Y and X.Y.Z version formats (Go commonly uses X.Y)
      matchpattern: '^go\s+(\d+\.\d+(?:\.\d+)?)$'

conditions:
  check-go-version-format:
    name: "Validate Go version format"
    kind: "shell"
    spec:
      # Allow optional patch version (X.Y or X.Y.Z)
      command: 'echo "{{ source "cagent-go-version" }}" | grep -E "^[0-9]+\.[0-9]+(\.[0-9]+)?$"'

targets:
  update-cagent-workflow:
    name: "Update Go version in cagent weekly build workflow"
    kind: "yaml"
    sourceid: "cagent-go-version"
    scmid: "default"
    spec:
      file: ".github/workflows/cagent-weekly-build.yml"
      # Note: steps[2] is "Set up Go" (0-indexed: 0=Checkout, 1=Update submodule, 2=Set up Go)
      # WARNING: Do not reorder steps before "Set up Go" or this automation will break
      key: "jobs.build-cagent.steps[2].with.go-version"

actions:
  default:
    kind: "github/pullrequest"
    scmid: "default"
    title: 'chore(ci): update cagent workflow Go version to {{ source "cagent-go-version" }}'
    spec:
      labels:
        - "dependencies"
        - "automation"
      description: |
        Automated update of Go version in cagent weekly build workflow.

        **cagent Go requirement:** `{{ source "cagent-go-version" }}`

        This PR updates the workflow to match the Go version required by cagent's go.mod file.

        Generated by UpdateCLI.
