---
# UpdateCLI manifest for tracking containerd versions in Gentoo overlay
# This manifest monitors docker-for-riscv64 releases and updates the containerd version

name: "Update Gentoo containerd package version"

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: "gounthar"
      repository: "docker-for-riscv64"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "main"

sources:
  # Track latest Docker Engine release (source of containerd binary)
  dockerRelease:
    kind: githubrelease
    name: "Get latest Docker Engine release"
    spec:
      owner: "gounthar"
      repository: "docker-for-riscv64"
      token: "{{ requiredEnv .github.token }}"
      typefilter:
        latest: true
      versionfilter:
        kind: regex
        pattern: '^v(\d+\.\d+\.\d+)-riscv64$'
    transformers:
      - trimprefix: "v"
      - trimsuffix: "-riscv64"

  # Extract containerd version from release assets
  containerdVersion:
    kind: shell
    name: "Extract containerd version from release"
    dependson:
      - dockerRelease
    spec:
      command: |
        DOCKER_VERSION="{{ source `dockerRelease` }}"
        # Get containerd version from release assets
        gh release view "v${DOCKER_VERSION}-riscv64" --repo gounthar/docker-for-riscv64 --json assets --jq '.assets[].name' | grep "containerd-" | grep ".rpm" | head -1 | sed -E 's/containerd-([0-9]+\.[0-9]+\.[0-9]+)-.*/\1/'
      environments:
        - name: PATH
        - name: GITHUB_TOKEN
          from: "{{ requiredEnv .github.token }}"

conditions:
  # Verify the containerd binary exists in the release
  containerdBinaryExists:
    kind: shell
    name: "Verify containerd binary in release"
    disablesourceinput: true
    spec:
      command: |
        DOCKER_VERSION="{{ source `dockerRelease` }}"
        gh release view "v${DOCKER_VERSION}-riscv64" --repo gounthar/docker-for-riscv64 --json assets --jq '.assets[].name' | grep -q "^containerd$"
      environments:
        - name: PATH
        - name: GITHUB_TOKEN
          from: "{{ requiredEnv .github.token }}"

targets:
  # Update version in generation script
  updateGenerationScript:
    name: "Update containerd version in generate-gentoo-overlay-modular.sh"
    kind: file
    sourceid: containerdVersion
    spec:
      file: "generate-gentoo-overlay-modular.sh"
      matchpattern: 'CONTAINERD_VERSION="([0-9]+\.[0-9]+\.[0-9]+)"'
      replacepattern: 'CONTAINERD_VERSION="{{ source `containerdVersion` }}"'
    scmid: default

actions:
  default:
    kind: github/pullrequest
    scmid: default
    title: 'chore(gentoo): update containerd to {{ source `containerdVersion` }}'
    spec:
      labels:
        - gentoo
        - containerd
        - automated
      description: |
        ## Automated Update: Gentoo containerd Package

        This PR updates the containerd version in the Gentoo overlay generation scripts.

        **Changes:**
        - containerd: {{ source `containerdVersion` }}
        - Source: Docker Engine release v{{ source `dockerRelease` }}-riscv64

        **Binary verified:** containerd binary exists in release assets

        ---
        ðŸ¤– Generated by UpdateCLI
