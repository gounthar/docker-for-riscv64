#!/usr/bin/make -f
# -*- makefile -*-
#
# Simplified rules for RISC-V64 pre-built binaries
# Based on official Debian docker.io package
# Source: https://salsa.debian.org/docker-team/docker

include /usr/share/dpkg/default.mk

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# Version information
DOCKER_VERSION := $(DEB_VERSION_UPSTREAM)

%:
	dh $@ --with=bash-completion

override_dh_auto_clean:
	dh_auto_clean
	rm -rf debian/tmphome

override_dh_auto_configure:
	# Skip configuration - we use pre-built binaries

override_dh_auto_build:
	# Skip build - binaries are pre-built from GitHub releases
	# They should be downloaded before running dpkg-buildpackage
	# Expected files: dockerd, docker-proxy, containerd, containerd-shim-runc-v2, runc
	@echo "Using pre-built binaries for RISC-V64"
	@test -f dockerd || (echo "Error: dockerd binary not found" && exit 1)
	@test -f docker-proxy || (echo "Error: docker-proxy binary not found" && exit 1)
	@echo "âœ“ All required binaries present"

override_dh_auto_test:
	# Skip tests - binaries are pre-built and tested upstream

override_dh_auto_install:
	# Skip dh_auto_install - we use dh_install

override_dh_install:
	dh_install -XLICENSE
	## Apparmor integration
	dh_apparmor --profile-name=docker.io -pdocker.io

override_dh_installinit:
	dh_installinit -v --name=docker --no-stop-on-upgrade --no-restart-after-upgrade

override_dh_installsystemd:
	dh_installsystemd -v --name=docker --no-stop-on-upgrade --no-restart-after-upgrade

override_dh_installudev:
	# use priority z80 to match the upstream priority of 80
	dh_installudev -v --name=docker --priority=z80

override_dh_shlibdeps:
	# Go binaries may have unusual dependencies
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info

override_dh_strip:
	# Don't strip Go binaries (they don't have standard debug symbols)
	dh_strip --no-automatic-dbgsym

override_dh_dwz:
	# Skip dwz compression (Go binaries don't benefit from it)
	@echo "Skipping dwz for Go binaries"

override_dh_gencontrol:
	## Include libc version in Built-Using
	dh_gencontrol -- -VBuilt-Using="$(shell dpkg-query -f '$${source:Package} (= $${source:Version})' -W libc-dev-bin)"
