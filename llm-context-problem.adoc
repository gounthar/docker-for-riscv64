= LLM Problem Context: Docker/Moby riscv64 Build with Local Registry

== Background/Goal

We are trying to build Docker Engine (Moby) for riscv64 using Debian trixie as the base. The workflow involves out-of-tree patching and custom image building to support an architecture and base image not available upstream.

== Current State

- We build a custom `golang:1.24.4-trixie` image locally using a patched Dockerfile.
- The image is pushed to a local registry (`host.docker.internal:5000`).
- The Moby Dockerfile is patched to use `host.docker.internal:5000/golang:1.24.4-trixie` as the base image for riscv64 builds.
- We use Docker Buildx/BuildKit for cross-arch builds.

== The Problem

When running the build, BuildKit fails to pull the base image from the local registry, with errors like:

  failed to do request: Head "http://host.docker.internal:5000/v2/golang/manifests/1.24.4-trixie": dial tcp [::1]:5000: connect: connection refused

or

  http: server gave HTTP response to HTTPS client

== Troubleshooting/Attempts

- The registry container is started and exposes port 5000.
- The image is pushed to the registry and visible in `docker ps`.
- We use `host.docker.internal:5000` in the Dockerfile and patch.
- Docker is configured to allow insecure registries:
+
[source,json]
----
"insecure-registries": ["host.docker.internal:5000"]
----
- We wait for the registry to be ready and test accessibility from both the host and a container.
- BuildKit/buildx still cannot pull the image from the local registry.

== Environment

- Docker Desktop on Windows (may also apply to Mac/Linux with VM networking).
- QEMU emulation for riscv64.
- BuildKit/buildx with docker-container driver.

== Desired Outcome

BuildKit should be able to pull the custom base image from the local registry at `host.docker.internal:5000` for riscv64 builds, allowing the build to proceed.

== What is the root cause and how can we make BuildKit use the local image for cross-arch builds?
