name: Weekly cagent RISC-V64 Build

on:
  schedule:
    # Run every Sunday at 06:00 UTC (after buildx build)
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      cagent_ref:
        description: 'cagent ref to build (branch/tag/commit)'
        required: false
        default: 'main'

permissions:
  contents: write
  actions: write

jobs:
  build-cagent:
    runs-on: [self-hosted, riscv64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Don't checkout all submodules - we only need cagent
          submodules: false
          fetch-depth: 0

      - name: Checkout cagent submodule only
        run: |
          # Only init and update the cagent submodule (skip moby, cli, compose)
          git submodule update --init --depth 1 cagent
          cd cagent
          # Force update tags to avoid conflicts with existing local tags
          git fetch origin --tags --force
          git checkout ${{ github.event.inputs.cagent_ref || 'main' }}
          # Pull only if it's a branch (not a tag or commit)
          if git symbolic-ref -q HEAD >/dev/null; then
            git pull origin ${{ github.event.inputs.cagent_ref || 'main' }}
          else
            echo "Checked out tag or commit, skipping pull"
          fi

      # WARNING: UpdateCLI automation targets this step at index [2].
      # Do not reorder steps before "Set up Go" or automation will break.
      # See .updatecli.d/cagent-go-version.yaml
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.5'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build cagent binary
        run: |
          set -euo pipefail
          cd cagent

          # Set version from git tag
          GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "dev")
          GIT_COMMIT=$(git rev-parse HEAD)
          echo "Building cagent version: $GIT_TAG"
          echo "Commit: $GIT_COMMIT"

          # Build with version info (CGO enabled for tree-sitter dependency)
          GOOS=linux GOARCH=riscv64 CGO_ENABLED=1 go build \
            -ldflags "-X 'github.com/docker/cagent/pkg/version.Version=${GIT_TAG}' -X 'github.com/docker/cagent/pkg/version.Commit=${GIT_COMMIT}'" \
            -o cagent-linux-riscv64 \
            ./main.go

          # Verify binary exists
          ls -lh cagent-linux-riscv64
          file cagent-linux-riscv64

      - name: Extract binary
        run: |
          DATE=$(date +%Y%m%d)
          mkdir -p release-cagent-$DATE

          # Copy binary
          cp cagent/cagent-linux-riscv64 release-cagent-$DATE/
          chmod +x release-cagent-$DATE/cagent-linux-riscv64

          # Get version
          ./release-cagent-$DATE/cagent-linux-riscv64 version > release-cagent-$DATE/VERSION.txt 2>&1 || echo "Version command not available"

          ls -lh release-cagent-$DATE/

      - name: Create release
        id: create_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          # Ensure gh is installed
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh || true
          fi

          DATE=$(date +%Y%m%d)
          CAGENT_REF="${{ github.event.inputs.cagent_ref || 'main' }}"

          # Get version from submodule
          cd cagent
          CAGENT_VERSION=$(git describe --tags --exact-match 2>/dev/null || git describe --tags --always)
          cd ..

          # Determine release version (handle both v1.9.13 and 1.9.13 formats)
          if [[ "$CAGENT_REF" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            # Official release: v1.9.13 or 1.9.13 -> cagent-v1.9.13-riscv64
            CLEAN_REF="${CAGENT_REF#v}"
            RELEASE_VERSION="cagent-v${CLEAN_REF}-riscv64"
            RELEASE_TITLE="cagent v${CLEAN_REF} for RISC-V64"
            VERSION_INFO="**cagent Version:** v${CLEAN_REF}"
          else
            # Development build
            RELEASE_VERSION="cagent-v${DATE}-dev"
            RELEASE_TITLE="cagent RISC-V64 Development Build ${DATE}"
            VERSION_INFO="**cagent Branch:** ${CAGENT_REF}
            **cagent Version:** ${CAGENT_VERSION}"
          fi

          # Output release version for next step
          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT

          cat > release-notes.md << EOF
          Automated build of cagent for RISC-V64

          ${VERSION_INFO}
          **Build Date:** $(date -u +%Y-%m-%d)
          **Architecture:** riscv64

          **About cagent:**
          cagent is a powerful, easy to use, customizable multi-agent runtime that
          orchestrates AI agents with specialized capabilities and tools.

          Key features:
          - Multi-agent architecture for domain-specific specialists
          - MCP (Model Context Protocol) integration for external tools
          - Smart task delegation between agents
          - YAML-based declarative configuration
          - Support for multiple AI providers (OpenAI, Anthropic, Gemini, xAI, Mistral)

          **Installation:**
          \`\`\`bash
          # Download binary
          wget https://github.com/gounthar/docker-for-riscv64/releases/download/${RELEASE_VERSION}/cagent-linux-riscv64
          chmod +x cagent-linux-riscv64

          # Install to system
          sudo mv cagent-linux-riscv64 /usr/bin/cagent
          # Or install to local bin
          mv cagent-linux-riscv64 ~/.local/bin/cagent

          # Verify
          cagent version
          \`\`\`

          **Build Command:**
          \`\`\`bash
          # Requires build-essential (gcc, g++, make) for CGO dependencies
          cd cagent
          GOOS=linux GOARCH=riscv64 CGO_ENABLED=1 go build \\
            -ldflags "-X 'github.com/docker/cagent/pkg/version.Version=${CAGENT_VERSION}'" \\
            -o cagent-linux-riscv64 ./main.go
          \`\`\`

          Automated build on RISC-V64 hardware
          EOF

          # For development builds, delete existing release if it exists
          if [[ "$RELEASE_VERSION" =~ -dev$ ]]; then
            echo "Checking for existing development release..."
            if gh release view "${RELEASE_VERSION}" >/dev/null 2>&1; then
              echo "Deleting existing release ${RELEASE_VERSION}..."
              gh release delete "${RELEASE_VERSION}" --yes
            fi
          fi

          gh release create "${RELEASE_VERSION}" \
            --title "${RELEASE_TITLE}" \
            --notes-file release-notes.md \
            release-cagent-$DATE/*

      - name: Trigger package builds for official releases
        if: ${{ !endsWith(steps.create_release.outputs.release_version, '-dev') }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          RELEASE_VERSION="${{ steps.create_release.outputs.release_version }}"

          # Wait briefly for release assets to be fully available
          echo "Waiting 10 seconds for release assets to become available..."
          sleep 10

          echo "Triggering Debian package build for ${RELEASE_VERSION}..."
          if ! gh workflow run build-cagent-package.yml -f release_tag="${RELEASE_VERSION}"; then
            echo "::error::Failed to trigger Debian package build"
            exit 1
          fi

          echo "Triggering RPM package build for ${RELEASE_VERSION}..."
          if ! gh workflow run build-cagent-rpm.yml -f release_tag="${RELEASE_VERSION}"; then
            echo "::error::Failed to trigger RPM package build"
            exit 1
          fi

          echo "âœ“ Package builds triggered successfully"
