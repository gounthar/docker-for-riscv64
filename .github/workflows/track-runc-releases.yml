name: Track Runc Releases

on:
  schedule:
    # Check for new releases daily at 10:00 UTC
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  actions: write

jobs:
  check-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for new runc release
        id: check
        run: |
          # Get latest stable release from opencontainers/runc
          LATEST=$(gh api repos/opencontainers/runc/releases/latest --jq '.tag_name // empty')

          if [ -z "$LATEST" ]; then
            echo "ERROR: Failed to fetch latest runc release"
            exit 1
          fi

          echo "latest_release=$LATEST" >> $GITHUB_OUTPUT

          # Runc is bundled in Docker Engine builds, not released separately.
          # Check if we already have an open or recent tracking issue for this version.
          EXISTING=$(gh issue list \
            --label "runc-release" \
            --state all \
            --limit 50 \
            --json number,title,state \
            --jq ".[] | select(.title | contains(\"${LATEST}\")) | .number" \
            | head -n1)

          if [ -n "$EXISTING" ]; then
            echo "already_tracked=true" >> $GITHUB_OUTPUT
            echo "Runc ${LATEST} already tracked in issue #${EXISTING}"
          else
            echo "already_tracked=false" >> $GITHUB_OUTPUT
          fi

          echo "Latest runc release: $LATEST"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Trigger Docker Engine rebuild with new runc
        if: steps.check.outputs.already_tracked == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}

          echo "New runc release detected: $LATEST"
          echo "Triggering Docker Engine rebuild..."

          # Trigger the Docker Engine build with the new runc version
          gh workflow run docker-weekly-build.yml -f runc_ref=$LATEST

          # Create tracking issue
          cat > issue-body.md << EOF
          New runc release detected: **$LATEST**

          **Status:** Docker Engine rebuild automatically triggered with runc_ref=$LATEST

          Runc is built as part of the Docker Engine build and bundled in the release.
          The docker-weekly-build workflow has been started automatically.

          **Monitor build progress:**
          \`\`\`bash
          gh run list --workflow=docker-weekly-build.yml --limit 1
          gh run watch
          \`\`\`

          **Upstream release notes:** https://github.com/opencontainers/runc/releases/tag/$LATEST

          This issue will be closed automatically when the Docker Engine build completes.
          EOF

          gh issue create \
            --title "Building runc ${LATEST} for Docker Engine RISC-V64" \
            --body-file issue-body.md \
            --label "build-in-progress,runc-release"

          echo "Build triggered successfully!"
