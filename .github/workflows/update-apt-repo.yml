name: Update APT Repository

on:
  workflow_run:
    workflows: ["Build Debian Package", "Build Docker Compose Debian Package", "Build Docker CLI Debian Package"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag containing the .deb package (v*-riscv64, compose-v*-riscv64, or cli-v*-riscv64)'
        required: true
        default: 'v28.5.1-riscv64'

jobs:
  update-repo:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout apt-repo branch
        uses: actions/checkout@v4
        with:
          ref: apt-repo
          fetch-depth: 0

      - name: Install reprepro
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro

      - name: Get release information
        id: release_info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get release tag from workflow run or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          else
            # Find the latest -riscv64 release (docker, compose, or cli)
            RELEASE_TAG=$(gh release list --repo gounthar/docker-for-riscv64 --limit 50 | \
                          grep -E '(compose-|cli-)?v[0-9]+\.[0-9]+\.[0-9]+-riscv64' | \
                          head -1 | \
                          awk '{print $1}')
          fi

          # Determine package type
          if [[ "$RELEASE_TAG" =~ ^compose- ]]; then
            PACKAGE_TYPE="compose"
            echo "package_type=compose" >> $GITHUB_OUTPUT
          elif [[ "$RELEASE_TAG" =~ ^cli- ]]; then
            PACKAGE_TYPE="cli"
            echo "package_type=cli" >> $GITHUB_OUTPUT
          else
            PACKAGE_TYPE="docker"
            echo "package_type=docker" >> $GITHUB_OUTPUT
          fi

          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "üì¶ Processing release: $RELEASE_TAG (type: $PACKAGE_TYPE)"

      - name: Download .deb package
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="${{ steps.release_info.outputs.release_tag }}"
          PACKAGE_TYPE="${{ steps.release_info.outputs.package_type }}"

          if [ "$PACKAGE_TYPE" = "compose" ]; then
            echo "Downloading docker-compose-plugin package from $RELEASE_TAG..."
            PATTERN="docker-compose-plugin_*.deb"
          elif [ "$PACKAGE_TYPE" = "cli" ]; then
            echo "Downloading docker-cli package from $RELEASE_TAG..."
            PATTERN="docker-cli_*.deb"
          else
            echo "Downloading docker.io package from $RELEASE_TAG..."
            PATTERN="docker.io_*.deb"
          fi

          # Download all matching .deb files from the release
          gh release download $RELEASE_TAG -p "$PATTERN" --repo gounthar/docker-for-riscv64 || {
            echo "‚ùå No .deb file found in release $RELEASE_TAG"
            echo "Available assets:"
            gh release view $RELEASE_TAG --repo gounthar/docker-for-riscv64
            exit 1
          }

          ls -lh *.deb

      - name: Add package to repository
        run: |
          echo "Adding package(s) to APT repository..."

          # Add all .deb packages (reprepro will handle duplicates)
          for deb in *.deb; do
            if [ -f "$deb" ]; then
              echo "Processing: $deb"
              reprepro -b . includedeb trixie "$deb" || {
                echo "‚ö†Ô∏è  Package already in repository or error occurred"
                reprepro -b . list trixie
              }
            fi
          done

          echo ""
          echo "Repository contents:"
          reprepro -b . list trixie

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          RELEASE_TAG="${{ steps.release_info.outputs.release_tag }}"
          PACKAGE_TYPE="${{ steps.release_info.outputs.package_type }}"

          # Extract version from tag
          if [ "$PACKAGE_TYPE" = "compose" ]; then
            VERSION=$(echo $RELEASE_TAG | sed 's/^compose-v//; s/-riscv64$//')
            PACKAGE_NAME="docker-compose-plugin"
            INSTALL_CMD="docker-compose-plugin"
          elif [ "$PACKAGE_TYPE" = "cli" ]; then
            VERSION=$(echo $RELEASE_TAG | sed 's/^cli-v//; s/-riscv64$//')
            PACKAGE_NAME="docker-cli"
            INSTALL_CMD="docker-cli"
          else
            VERSION=$(echo $RELEASE_TAG | sed 's/^v//; s/-riscv64$//')
            PACKAGE_NAME="docker.io"
            INSTALL_CMD="docker.io"
          fi

          # Check if there are changes
          if git diff --quiet dists pool 2>/dev/null; then
            echo "üìù No changes to commit (package may already exist)"
            exit 0
          fi

          git add dists pool
          git commit -m "Add $PACKAGE_NAME $VERSION from release $RELEASE_TAG" \
                     -m "Automated update from GitHub Actions." \
                     -m "Package: ${PACKAGE_NAME}_${VERSION}-*_riscv64.deb" \
                     -m "Release: $RELEASE_TAG" \
                     -m "Workflow: ${{ github.workflow }}" \
                     -m "Run: ${{ github.run_id }}"

          git push

          echo ""
          echo "‚úÖ APT repository updated successfully!"
          echo "üìç Repository URL: https://gounthar.github.io/docker-for-riscv64"
          echo ""
          echo "Users can now install with:"
          echo "  sudo apt-get update"
          echo "  sudo apt-get install $INSTALL_CMD"
