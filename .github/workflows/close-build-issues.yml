name: Close Build Issues

on:
  release:
    types: [published]

jobs:
  close-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Close matching build-in-progress issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          RELEASE_TAG="${{ github.event.release.tag_name }}"
          echo "Release published: $RELEASE_TAG"

          # Extract version and component from release tag
          # Examples: v28.0.0-riscv64, compose-v2.40.1-riscv64, cli-v28.0.0-riscv64,
          #           tini-v0.19.0-riscv64, buildkit-v0.20.0-riscv64, cagent-v1.15.0-riscv64

          # Common label for all build tracking issues
          LABEL="build-in-progress"

          # Build search patterns based on release tag format
          case "$RELEASE_TAG" in
            compose-v*)
              VERSION=$(echo "$RELEASE_TAG" | sed 's/compose-\(v[0-9.]*\)-riscv64/\1/')
              SEARCH="Compose $VERSION"
              ;;
            cli-v*)
              VERSION=$(echo "$RELEASE_TAG" | sed 's/cli-\(v[0-9.]*\)-riscv64/\1/')
              SEARCH="CLI $VERSION"
              ;;
            tini-v*)
              VERSION=$(echo "$RELEASE_TAG" | sed 's/tini-\(v[0-9.]*\)-riscv64/\1/')
              SEARCH="tini $VERSION"
              ;;
            buildkit-v*)
              VERSION=$(echo "$RELEASE_TAG" | sed 's/buildkit-\(v[0-9.]*\)-riscv64/\1/')
              SEARCH="BuildKit $VERSION"
              ;;
            buildx-v*)
              VERSION=$(echo "$RELEASE_TAG" | sed 's/buildx-\(v[0-9.]*\)-riscv64/\1/')
              SEARCH="Buildx $VERSION"
              ;;
            cagent-v*)
              VERSION=$(echo "$RELEASE_TAG" | sed 's/cagent-\(v[0-9.]*\)-riscv64/\1/')
              SEARCH="cagent $VERSION"
              ;;
            v*)
              # Docker Engine (moby) releases: v28.0.0-riscv64
              # Issue titles use format "Building Docker docker-vX.Y.Z for RISC-V64"
              VERSION=$(echo "$RELEASE_TAG" | sed 's/\(v[0-9.]*\)-riscv64/\1/')
              SEARCH="docker-$VERSION"
              ;;
            *)
              echo "Unknown release tag format: $RELEASE_TAG"
              exit 0
              ;;
          esac

          # Validate version extraction succeeded
          if [ -z "$VERSION" ]; then
            echo "Failed to extract version from: $RELEASE_TAG"
            exit 1
          fi

          echo "Looking for issues matching: $SEARCH"

          # Find and close matching issues
          # Using || true to handle case where no issues match (jq returns empty)
          ISSUES=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "$LABEL" \
            --state open \
            --json number,title \
            --jq ".[] | select(.title | test(\"$SEARCH\"; \"i\")) | .number") || true

          if [ -z "$ISSUES" ]; then
            echo "No matching issues found"
            exit 0
          fi

          echo "Found issues to close: $ISSUES"

          # Close each issue (issue numbers are simple integers, safe for word splitting)
          for ISSUE in $ISSUES; do
            echo "Closing issue #$ISSUE"
            gh issue close "$ISSUE" \
              --repo "${{ github.repository }}" \
              --comment "Automatically closed: Release [$RELEASE_TAG](${{ github.event.release.html_url }}) has been published."
          done

          echo "Done! Closed $(echo "$ISSUES" | wc -w) issue(s)"
