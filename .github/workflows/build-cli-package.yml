name: Build Docker CLI Debian Package

on:
  # Only trigger from Weekly Build - Track workflow completes before release exists
  workflow_run:
    workflows: ["Weekly Docker CLI RISC-V64 Build"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'CLI release tag (leave empty to auto-detect latest)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: [self-hosted, riscv64]
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check if release is official (not dev build)
        id: check_release
        run: |
          set -euo pipefail

          # Skip check for manual dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual dispatch - proceeding with build"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get the latest official CLI release (exclude dev builds)
          LATEST_RELEASE=$(gh release list --repo ${{ github.repository }} --limit 10 | \
            grep -E 'cli-v[0-9]+\.[0-9]+\.[0-9]+-riscv64' | head -1 | awk '{print $(NF-1)}' || echo "")

          echo "Latest CLI release: $LATEST_RELEASE"

          if [ -z "$LATEST_RELEASE" ]; then
            echo "No CLI release found - skipping package build"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if it's an official release (cli-vX.Y.Z-riscv64) or dev build (cli-vYYYYMMDD-dev)
          if [[ "$LATEST_RELEASE" =~ ^cli-v[0-9]{8}-dev$ ]]; then
            echo "Development build detected: $LATEST_RELEASE"
            echo "Skipping package build for dev releases"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if release already has .deb packages
          ASSETS=$(gh release view "$LATEST_RELEASE" --json assets --jq '.assets[].name' 2>/dev/null || echo "")
          if echo "$ASSETS" | grep -q 'docker-cli.*\.deb$'; then
            echo "Release $LATEST_RELEASE already has Debian packages - skipping build"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Release $LATEST_RELEASE needs Debian packages - proceeding with build"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install build dependencies
        if: steps.check_release.outputs.skip != 'true'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper dh-make dpkg-dev lintian devscripts libdistro-info-perl
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get install -y gh || true
          fi

      - name: Download CLI binary
        if: steps.check_release.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          # Get release tag from workflow_run or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
            # If empty/not provided, auto-detect latest
            if [ -z "$RELEASE_TAG" ]; then
              echo "No release tag provided, auto-detecting latest CLI release..."
              RELEASE_TAG=$(gh release list --repo gounthar/docker-for-riscv64 --limit 10 | \
                            grep -E 'cli-v[0-9]+\.[0-9]+\.[0-9]+-riscv64' | \
                            head -1 | \
                            awk '{print $(NF-1)}')
            fi
          else
            # Find the latest CLI release created by the workflow
            RELEASE_TAG=$(gh release list --repo gounthar/docker-for-riscv64 --limit 10 | \
                          grep -E 'cli-v[0-9]+\.[0-9]+\.[0-9]+-riscv64' | \
                          head -1 | \
                          awk '{print $(NF-1)}')
          fi

          # Validate RELEASE_TAG is not empty
          if [ -z "$RELEASE_TAG" ]; then
            echo "Error: Could not determine CLI release tag"
            exit 1
          fi

          echo "Building package for release: $RELEASE_TAG"

          # Download binary
          gh release download $RELEASE_TAG -p docker
          chmod +x docker

          # Verify binary architecture
          file ./docker || true
          readelf -h ./docker 2>/dev/null | sed -n '1,5p' || true
          ./docker --version || echo "Version command not available yet"

          ls -lh docker

      - name: Update package version in changelog
        if: steps.check_release.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          # Get release tag from workflow_run or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
            # If empty/not provided, auto-detect latest
            if [ -z "$RELEASE_TAG" ]; then
              echo "No release tag provided, auto-detecting latest CLI release..."
              RELEASE_TAG=$(gh release list --repo gounthar/docker-for-riscv64 --limit 10 | \
                            grep -E 'cli-v[0-9]+\.[0-9]+\.[0-9]+-riscv64' | \
                            head -1 | \
                            awk '{print $(NF-1)}')
            fi
          else
            # Find the latest CLI release created by the workflow
            RELEASE_TAG=$(gh release list --repo gounthar/docker-for-riscv64 --limit 10 | \
                          grep -E 'cli-v[0-9]+\.[0-9]+\.[0-9]+-riscv64' | \
                          head -1 | \
                          awk '{print $(NF-1)}')
          fi
          VERSION="$(echo "$RELEASE_TAG" | sed 's/^cli-v//; s/-riscv64$//')"
          echo "Package version: $VERSION"

          # Set DEBEMAIL to avoid interactive prompt
          export DEBEMAIL="github-actions[bot]@users.noreply.github.com"
          export DEBFULLNAME="GitHub Actions"

          # Copy packaging and update changelog with dch
          cp -r debian-cli debian
          cd debian
          dch --newversion "${VERSION}-riscv64-1" \
              --distribution trixie \
              --force-distribution \
              --check-dirname-level 0 \
              "RISC-V64 prebuilt docker-cli ${VERSION}"
          cd ..

      - name: Build package
        if: steps.check_release.outputs.skip != 'true'
        run: |
          # Build package (debian/ already created in previous step)
          # Use -d to skip build dependency checks (we're packaging prebuilt binaries)
          # Use -a riscv64 to specify target architecture (building on amd64 host)
          dpkg-buildpackage -us -uc -b -d -a riscv64

          ls -lh ../*.deb

      - name: Run lintian checks
        if: steps.check_release.outputs.skip != 'true'
        run: |
          lintian --info --display-info ../*.deb || true

      - name: Package info
        if: steps.check_release.outputs.skip != 'true'
        run: |
          for deb in ../*.deb; do
            echo "============================================"
            echo "=== Package: $(basename $deb) ==="
            echo "============================================"
            echo ""
            echo "=== Package Contents ==="
            dpkg-deb --contents "$deb" | head -50
            echo ""
            echo "=== Package Info ==="
            dpkg-deb --info "$deb"
            echo ""
            echo "=== Package Size ==="
            ls -lh "$deb"
            echo ""
          done

      - name: Upload packages to release
        if: steps.check_release.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          # Get release tag from workflow_run or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
            # If empty/not provided, auto-detect latest
            if [ -z "$RELEASE_TAG" ]; then
              echo "No release tag provided, auto-detecting latest CLI release..."
              RELEASE_TAG=$(gh release list --repo gounthar/docker-for-riscv64 --limit 10 | \
                            grep -E 'cli-v[0-9]+\.[0-9]+\.[0-9]+-riscv64' | \
                            head -1 | \
                            awk '{print $(NF-1)}')
            fi
          else
            # Find the latest CLI release created by the workflow
            RELEASE_TAG=$(gh release list --repo gounthar/docker-for-riscv64 --limit 10 | \
                          grep -E 'cli-v[0-9]+\.[0-9]+\.[0-9]+-riscv64' | \
                          head -1 | \
                          awk '{print $(NF-1)}')
          fi

          # Validate RELEASE_TAG is not empty
          if [ -z "$RELEASE_TAG" ]; then
            echo "Error: Could not determine CLI release tag"
            exit 1
          fi

          echo "Uploading packages to release $RELEASE_TAG"
          echo ""

          for deb in ../*.deb; do
            echo "Uploading $(basename $deb)..."
            for i in {1..3}; do
              gh release upload "$RELEASE_TAG" "$deb" --clobber && break
              echo "Retry $i..."
              sleep 3
            done
          done

          echo ""
          echo "âœ… Docker CLI Debian package uploaded successfully!"
          echo ""
          echo "Packages built:"
          ls -lh ../*.deb
          echo ""
          echo "Install with:"
          echo "  wget https://github.com/gounthar/docker-for-riscv64/releases/download/${RELEASE_TAG}/docker-cli_*.deb"
          echo "  sudo dpkg -i docker-cli_*.deb"
          echo "  docker --version"
