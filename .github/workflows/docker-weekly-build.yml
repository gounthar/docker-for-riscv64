name: Weekly Docker RISC-V64 Build

on:
  schedule:
    # Run every Sunday at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      moby_ref:
        description: 'Moby ref to build (branch/tag/commit)'
        required: false
        default: 'master'

jobs:
  build-docker:
    runs-on: [self-hosted, riscv64]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Update moby submodule
        run: |
          cd moby
          git fetch origin
          git checkout ${{ github.event.inputs.moby_ref || 'master' }}
          git pull origin ${{ github.event.inputs.moby_ref || 'master' }}
      
      - name: Apply RISC-V patches
        run: |
          cd moby
          # Comment out frozen-images (no riscv64 manifests)
          sed -i '116,123s/^/# /' Dockerfile
          sed -i '123a\RUN mkdir -p /build' Dockerfile
          sed -i '/^COPY.*frozen-images/s/^/# /' Dockerfile
          
          # Comment out dockercli-integration (old CLI)
          sed -i '243,248s/^/# /' Dockerfile
          sed -i '248a\RUN mkdir -p /build' Dockerfile
          sed -i '/^COPY.*dockercli-integration/s/^/# /' Dockerfile
      
      - name: Build Docker development image
        run: |
          cd moby
          docker build \
            --build-arg BASE_DEBIAN_DISTRO=trixie \
            --build-arg GO_VERSION=1.25.3 \
            -f Dockerfile \
            -t docker-riscv64:dev-$(date +%Y%m%d) \
            .
      
      - name: Build Docker binaries
        run: |
          cd moby
          docker build \
            --build-arg BASE_DEBIAN_DISTRO=trixie \
            --build-arg GO_VERSION=1.25.3 \
            --target=binary \
            -f Dockerfile \
            -t docker-riscv64:binary-$(date +%Y%m%d) \
            .
      
      - name: Extract binaries
        run: |
          DATE=$(date +%Y%m%d)
          mkdir -p release-$DATE
          
          # Extract from bundles directory
          cp moby/bundles/binary/dockerd release-$DATE/
          cp moby/bundles/binary/docker-proxy release-$DATE/
          
          # Get versions
          ./release-$DATE/dockerd --version > release-$DATE/versions.txt
          ./release-$DATE/docker-proxy --version >> release-$DATE/versions.txt
          
          ls -lh release-$DATE/
      
      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE=$(date +%Y%m%d)
          MOBY_COMMIT=$(cd moby && git rev-parse --short HEAD)

          cat > release-notes.md << EOF
          Automated weekly build of Docker Engine for RISC-V64

          **Moby Version:** ${MOBY_COMMIT}
          **Build Date:** $(date -u +%Y-%m-%d)
          **Architecture:** riscv64

          **Components:**
          - dockerd (Docker Engine)
          - docker-proxy (Network proxy)

          **Build Command:**
          \`\`\`bash
          docker build --build-arg BASE_DEBIAN_DISTRO=trixie \\
                       --build-arg GO_VERSION=1.25.3 \\
                       --target=binary \\
                       -f moby/Dockerfile .
          \`\`\`

          **Installation:**
          \`\`\`bash
          # Download binaries
          wget https://github.com/gounthar/docker-for-riscv64/releases/download/v${DATE}-${MOBY_COMMIT}/dockerd
          wget https://github.com/gounthar/docker-for-riscv64/releases/download/v${DATE}-${MOBY_COMMIT}/docker-proxy

          # Make executable
          chmod +x dockerd docker-proxy

          # Install (requires root)
          sudo cp dockerd docker-proxy /usr/local/bin/
          \`\`\`

          Automated build on RISC-V64 hardware
          EOF

          gh release create "v${DATE}-${MOBY_COMMIT}" \
            --title "Docker RISC-V64 Build ${DATE}" \
            --notes-file release-notes.md \
            release-$DATE/*
