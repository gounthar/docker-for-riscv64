name: Track Docker Scout Releases

on:
  schedule:
    # Check for new releases daily at 09:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  check-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check for new Scout release
        id: check
        run: |
          set -euo pipefail

          # Get latest scout-cli release
          LATEST=$(gh api repos/docker/scout-cli/releases/latest --jq '.tag_name' 2>/dev/null || echo "")

          if [ -z "$LATEST" ]; then
            echo "Could not fetch latest Scout release"
            echo "already_built=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "latest_release=$LATEST" >> $GITHUB_OUTPUT

          # Check if we've already built this (using -riscv64 suffix)
          RELEASE_TAG="scout-${LATEST}-riscv64"
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "already_built=true" >> $GITHUB_OUTPUT
          else
            echo "already_built=false" >> $GITHUB_OUTPUT
          fi

          echo "Latest Scout release: $LATEST"
          echo "Checking for: $RELEASE_TAG"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Trigger automatic build for new release
        if: steps.check.outputs.already_built == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          LATEST=${{ steps.check.outputs.latest_release }}

          echo "New Scout release detected: $LATEST"
          echo "Triggering automatic build..."

          # Trigger the build workflow
          gh workflow run scout-weekly-build.yml -f scout_ref=$LATEST

          # Create tracking issue
          cat > issue-body.md << EOF
          New Docker Scout release detected: **$LATEST**

          **Status:** Build automatically triggered

          The Weekly Docker Scout RISC-V64 Build workflow has been started automatically.
          Expected completion time: ~5-10 minutes

          **Monitor build progress:**
          \`\`\`bash
          gh run list --workflow=scout-weekly-build.yml --limit 1
          gh run watch
          \`\`\`

          **Expected release:** scout-${LATEST}-riscv64

          **Upstream release notes:** https://github.com/docker/scout-cli/releases/tag/$LATEST

          This issue will track the build progress. Close it once the release is published.
          EOF

          gh issue create \
            --title "Building Docker Scout ${LATEST} for RISC-V64" \
            --body-file issue-body.md \
            --label "build-in-progress,docker-scout"

          echo "Build triggered successfully!"
