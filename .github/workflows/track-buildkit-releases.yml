name: Track BuildKit Releases

on:
  schedule:
    # Check for new releases daily at 08:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  actions: write

jobs:
  check-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for new BuildKit release
        id: check
        run: |
          # Get latest stable release from moby/buildkit repository
          # Filter for vX.Y.Z releases (exclude dockerfile/* and pre-releases)
          LATEST=$(gh release list --repo moby/buildkit --limit 20 \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+\s' \
            | grep -v 'Pre-release' \
            | head -1 \
            | awk '{print $1}')

          if [ -z "$LATEST" ]; then
            echo "Could not determine latest BuildKit release"
            exit 1
          fi

          echo "latest_release=$LATEST" >> $GITHUB_OUTPUT

          # Check if we've already built this (using buildkit-v*-riscv64 format)
          # BuildKit tags are like v0.26.2, we create buildkit-v0.26.2-riscv64
          OUR_TAG="buildkit-${LATEST}-riscv64"

          if gh release view "${OUR_TAG}" >/dev/null 2>&1; then
            echo "already_built=true" >> $GITHUB_OUTPUT
          else
            echo "already_built=false" >> $GITHUB_OUTPUT
          fi

          echo "Latest BuildKit release: $LATEST"
          echo "Checking for: ${OUR_TAG}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check for duplicate tracking issue
        id: dedup
        if: steps.check.outputs.already_built == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}
          EXISTING=$(gh issue list \
            --label buildkit-release \
            --state all \
            --search "in:title Building BuildKit ${LATEST} for RISC-V64" \
            --json number,title \
            --jq 'map(select(.title == "Building BuildKit '"${LATEST}"' for RISC-V64")) | .[0].number // empty') || {
            echo "ERROR: gh issue list failed while checking duplicates for BuildKit ${LATEST}"
            exit 1
          }

          if [ -n "$EXISTING" ]; then
            echo "ℹ️ Tracking issue #$EXISTING already exists for BuildKit ${LATEST}, skipping build and issue"
            echo "is_duplicate=true" >> $GITHUB_OUTPUT
          else
            echo "is_duplicate=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger automatic build for new release
        if: steps.check.outputs.already_built == 'false' && steps.dedup.outputs.is_duplicate != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}

          echo "New BuildKit release detected: $LATEST"
          echo "Triggering automatic build..."

          gh workflow run buildkit-weekly-build.yml -f buildkit_ref=$LATEST

          echo "Build triggered successfully!"

      - name: Create tracking issue
        if: steps.check.outputs.already_built == 'false' && steps.dedup.outputs.is_duplicate != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}
          cat > issue-body.md << ISSUE_EOF
          New BuildKit release detected: **$LATEST**

          **Status:** Build automatically triggered

          The buildkit-weekly-build workflow has been started automatically.
          Expected completion time: ~35-40 minutes

          **Monitor build progress:**
          \`\`\`bash
          gh run list --workflow=buildkit-weekly-build.yml --limit 1
          gh run watch
          \`\`\`

          **Expected release:** buildkit-${LATEST}-riscv64

          **Expected artifacts:**
          - \`buildkitd\` - BuildKit daemon
          - \`buildctl\` - BuildKit CLI client
          - Container image: \`ghcr.io/gounthar/buildkit-riscv64:${LATEST}-riscv64\`

          **Upstream release notes:** https://github.com/moby/buildkit/releases/tag/$LATEST

          This issue will track the build progress. Close it once the release is published.
          ISSUE_EOF

          gh issue create \
            --title "Building BuildKit ${LATEST} for RISC-V64" \
            --body-file issue-body.md \
            --label "build-in-progress,buildkit-release"

      - name: Log status when already built
        if: steps.check.outputs.already_built == 'true'
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}
          echo "BuildKit $LATEST already built as buildkit-${LATEST}-riscv64"
          echo "No action needed."
