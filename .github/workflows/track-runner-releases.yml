name: Track Runner Releases

'on':
  schedule:
    # Check for new releases daily at 07:00 UTC
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  check-release:
    runs-on: [self-hosted, riscv64]
    
    steps:
      - name: Check for new github-act-runner release
        id: check
        run: |
          # Get latest runner release
          LATEST=$(gh api repos/ChristopherHX/github-act-runner/releases/latest --jq '.tag_name')
          echo "latest_release=$LATEST" >> $GITHUB_OUTPUT
          
          # Check current version
          CURRENT=$(~/github-act-runner-test/github-act-runner --version 2>&1 | grep -oP 'v\d+\.\d+\.\d+' || echo "unknown")
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          
          if [ "$LATEST" != "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Latest runner: $LATEST"
          echo "Current runner: $CURRENT"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Trigger automated update
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}
          CURRENT=${{ steps.check.outputs.current_version }}

          echo "ðŸš€ Triggering automated runner update..."
          echo "  Current: $CURRENT"
          echo "  Target: $LATEST"

          # Trigger the update workflow
          gh workflow run update-runner.yml \
            --repo gounthar/docker-for-riscv64 \
            -f version="$LATEST"

          echo "âœ… Update workflow triggered"
          echo "ðŸ“Š Monitor progress: gh run list --workflow=update-runner.yml"

      - name: Create tracking issue
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}
          CURRENT=${{ steps.check.outputs.current_version }}

          cat > issue-body.md << EOF
          Automated runner update triggered!

          **Current version:** $CURRENT
          **New version:** $LATEST

          **Status:** Update workflow has been triggered automatically.

          **Monitor progress:**
          \`\`\`bash
          gh run list --workflow=update-runner.yml --limit 5
          gh run watch
          \`\`\`

          **Manual update (if automation fails):**
          \`\`\`bash
          ssh poddingue@192.168.1.185
          cd ~/github-act-runner-test
          git pull
          go build -v -o github-act-runner .

          # Restart runner service
          sudo systemctl restart github-runner
          \`\`\`

          **Logs:**
          - Build logs: \`~/github-act-runner-test/build.log\`
          - Restart logs: \`/tmp/runner-restart.log\`
          - Service status: \`systemctl status github-runner\`

          Release notes: https://github.com/ChristopherHX/github-act-runner/releases/tag/$LATEST
          EOF

          gh issue create \
            --repo gounthar/docker-for-riscv64 \
            --title "Update github-act-runner to $LATEST" \
            --body-file issue-body.md \
            --label "maintenance,runner-update"
