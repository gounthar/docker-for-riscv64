name: Track Runner Releases

'on':
  schedule:
    # Check for new releases daily at 07:00 UTC
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  check-release:
    runs-on: [self-hosted, riscv64]

    steps:
      - name: Check for new github-act-runner release
        id: check
        run: |
          # Get latest runner release
          LATEST=$(gh api repos/ChristopherHX/github-act-runner/releases/latest --jq '.tag_name')

          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "ERROR: Failed to fetch latest github-act-runner release"
            exit 1
          fi

          echo "latest_release=$LATEST" >> $GITHUB_OUTPUT

          # Check current version - try multiple methods
          CURRENT="unknown"

          # Method 1: Check git tag in source directory (if exists)
          for dir in ~/github-act-runner ~/github-act-runner-test /opt/github-act-runner; do
            if [ -d "$dir/.git" ]; then
              CURRENT=$(cd "$dir" && git describe --tags --exact-match 2>/dev/null || echo "")
              if [ -n "$CURRENT" ]; then
                echo "Found version from git in $dir"
                break
              fi
            fi
          done

          # Method 2: Try to get version from binary (falls back if git method failed)
          if [ "$CURRENT" = "unknown" ] || [ -z "$CURRENT" ]; then
            # Look for the runner binary
            for bin in ~/github-act-runner/github-act-runner /opt/github-act-runner/github-act-runner; do
              if [ -x "$bin" ]; then
                VER=$("$bin" --version 2>/dev/null | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "")
                if [ -n "$VER" ]; then
                  CURRENT="$VER"
                  echo "Found version from binary: $CURRENT"
                  break
                fi
              fi
            done
          fi

          # If still unknown, that's okay - we'll report it
          [ -z "$CURRENT" ] && CURRENT="unknown"
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT

          if [ "$CURRENT" = "unknown" ]; then
            echo "needs_update=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ Could not determine current runner version"
          elif [ "$LATEST" != "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

          echo "Latest runner: $LATEST"
          echo "Current runner: $CURRENT"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Check for duplicate tracking issue
        id: dedup
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}
          EXISTING=$(gh issue list \
            --repo gounthar/docker-for-riscv64 \
            --label runner-update \
            --state all \
            --search "in:title Update github-act-runner to $LATEST" \
            --json number,title \
            --jq 'map(select(.title == "Update github-act-runner to '"$LATEST"'")) | .[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "â„¹ï¸ Tracking issue #$EXISTING already exists for runner $LATEST, skipping update and issue"
            echo "is_duplicate=true" >> $GITHUB_OUTPUT
          else
            echo "is_duplicate=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger automated update
        if: steps.check.outputs.needs_update == 'true' && steps.dedup.outputs.is_duplicate != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}
          CURRENT=${{ steps.check.outputs.current_version }}

          echo "ðŸš€ Triggering automated runner update..."
          echo "  Current: $CURRENT"
          echo "  Target: $LATEST"

          # Trigger the update workflow
          gh workflow run update-runner.yml \
            --repo gounthar/docker-for-riscv64 \
            -f version="$LATEST"

          echo "âœ… Update workflow triggered"
          echo "ðŸ“Š Monitor progress: gh run list --workflow=update-runner.yml"

      - name: Create tracking issue
        if: steps.check.outputs.needs_update == 'true' && steps.dedup.outputs.is_duplicate != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=${{ steps.check.outputs.latest_release }}
          CURRENT=${{ steps.check.outputs.current_version }}

          cat > issue-body.md << EOF
          Automated runner update triggered!

          **Current version:** $CURRENT
          **New version:** $LATEST

          **Status:** Update workflow has been triggered automatically.

          **Monitor progress:**
          \`\`\`bash
          gh run list --workflow=update-runner.yml --limit 5
          gh run watch
          \`\`\`

          **Manual update (if automation fails):**
          \`\`\`bash
          ssh poddingue@192.168.1.185
          cd ~/github-act-runner-test
          git pull
          go build -v -o github-act-runner .

          # Restart runner service
          sudo systemctl restart github-runner
          \`\`\`

          **Logs:**
          - Build logs: \`~/github-act-runner-test/build.log\`
          - Restart logs: \`/tmp/runner-restart.log\`
          - Service status: \`systemctl status github-runner\`

          Release notes: https://github.com/ChristopherHX/github-act-runner/releases/tag/$LATEST
          EOF

          gh issue create \
            --repo gounthar/docker-for-riscv64 \
            --title "Update github-act-runner to $LATEST" \
            --body-file issue-body.md \
            --label "maintenance,runner-update"
