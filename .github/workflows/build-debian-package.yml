name: Build Debian Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to build package from'
        required: true
        default: 'v28.5.1-riscv64'

jobs:
  build-deb:
    runs-on: [self-hosted, riscv64]
    if: contains(github.event.release.tag_name, '-riscv64') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper dh-make dpkg-dev lintian

      - name: Download release binaries
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get release tag
          if [ "${{ github.event_name }}" = "release" ]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          else
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          fi

          echo "Building package for release: $RELEASE_TAG"

          # Download all binaries
          for binary in dockerd docker-proxy containerd containerd-shim-runc-v2 runc; do
            gh release download $RELEASE_TAG -p $binary
          done

          chmod +x *
          ls -lh

      - name: Update package version in changelog
        run: |
          # Extract version from tag (v28.5.1-riscv64 -> 28.5.1)
          RELEASE_TAG="${{ github.event.release.tag_name || github.event.inputs.release_tag }}"
          VERSION=$(echo $RELEASE_TAG | sed 's/^v//; s/-riscv64$//')

          # Get moby commit info for changelog
          cd moby 2>/dev/null || true
          MOBY_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          cd ..

          # Check if this version is already in changelog
          if ! head -1 debian/changelog | grep -q "$VERSION"; then
            echo "Version $VERSION not in changelog, needs update"
            # In production, use dch to add entry, but changelog should be pre-updated
          fi

          echo "Package version: $VERSION"
          echo "Moby commit: $MOBY_COMMIT"

      - name: Build package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Run lintian checks
        run: |
          lintian --info --display-info ../docker.io_*.deb || true

      - name: Package info
        run: |
          echo "=== Package Contents ==="
          dpkg-deb --contents ../docker.io_*.deb | head -50

          echo ""
          echo "=== Package Info ==="
          dpkg-deb --info ../docker.io_*.deb

          echo ""
          echo "=== Package Size ==="
          ls -lh ../docker.io_*.deb

      - name: Upload package to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name || github.event.inputs.release_tag }}"
          DEB_FILE=$(ls ../docker.io_*.deb)

          echo "Uploading $DEB_FILE to release $RELEASE_TAG"
          gh release upload $RELEASE_TAG $DEB_FILE --clobber

          echo ""
          echo "âœ… Debian package uploaded successfully!"
          echo "Install with:"
          echo "  wget https://github.com/gounthar/docker-for-riscv64/releases/download/${RELEASE_TAG}/$(basename $DEB_FILE)"
          echo "  sudo dpkg -i $(basename $DEB_FILE)"
          echo "  sudo apt-get install -f"
