name: Build Debian Package

on:
  # Only trigger from Build workflow - Track workflow completes before release exists
  workflow_run:
    workflows: ["Build Docker RISC-V64"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to build package from'
        required: true
        default: 'v28.5.1-riscv64'

jobs:
  build-deb:
    runs-on: [self-hosted, riscv64]
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check if new release exists
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Skip check for manual dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual dispatch - proceeding with build"
            echo "has_new_release=true" >> $GITHUB_OUTPUT
            echo "release_tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find the latest docker release
          RELEASE_TAG=$(gh release list --repo gounthar/docker-for-riscv64 --limit 10 --json tagName,createdAt | \
                        jq -r '.[] | select(.tagName | test("^v[0-9]+\\.[0-9]+\\.[0-9]+-riscv64$")) | .tagName' | \
                        head -1)

          if [ -z "$RELEASE_TAG" ]; then
            echo "No Docker release found - skipping package build"
            echo "has_new_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if release already has .deb packages
          ASSETS=$(gh release view "$RELEASE_TAG" --json assets --jq '.assets[].name' 2>/dev/null || echo "")
          if echo "$ASSETS" | grep -q 'docker\.io.*\.deb$'; then
            echo "Release $RELEASE_TAG already has Debian packages - skipping build"
            echo "has_new_release=false" >> $GITHUB_OUTPUT
          else
            echo "Release $RELEASE_TAG needs Debian packages - proceeding with build"
            echo "has_new_release=true" >> $GITHUB_OUTPUT
            echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Install build dependencies
        if: steps.check_release.outputs.has_new_release == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper dh-make dpkg-dev lintian devscripts libdistro-info-perl

      - name: Download release binaries
        if: steps.check_release.outputs.has_new_release == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Use release tag from check_release step
          RELEASE_TAG="${{ steps.check_release.outputs.release_tag }}"

          echo "Building package for release: $RELEASE_TAG"

          # Download all binaries
          for binary in dockerd docker-proxy containerd containerd-shim-runc-v2 runc; do
            gh release download $RELEASE_TAG -p $binary
          done

          chmod +x *
          ls -lh

      - name: Prepare Debian packaging
        if: steps.check_release.outputs.has_new_release == 'true'
        run: |
          # Copy debian packaging files from debian-docker to debian
          cp -r debian-docker debian
          echo "Debian packaging prepared"

      - name: Update package version in changelog
        if: steps.check_release.outputs.has_new_release == 'true'
        run: |
          # Use release tag from check_release step
          RELEASE_TAG="${{ steps.check_release.outputs.release_tag }}"
          # Extract version from tag (v28.5.1-riscv64 -> 28.5.1)
          VERSION=$(echo $RELEASE_TAG | sed 's/^v//; s/-riscv64$//')

          # Get moby commit info for changelog
          cd moby 2>/dev/null || true
          MOBY_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          cd ..

          # Set DEBEMAIL to avoid interactive prompt
          export DEBEMAIL="github-actions[bot]@users.noreply.github.com"
          export DEBFULLNAME="GitHub Actions"

          # Check if this version is already in changelog
          if ! head -1 debian/changelog | grep -q "$VERSION"; then
            echo "Version $VERSION not in changelog, updating..."
            cd debian
            dch --newversion "${VERSION}-1" \
                --distribution trixie \
                --force-distribution \
                --check-dirname-level 0 \
                "RISC-V64 prebuilt Docker Engine ${VERSION} from upstream moby/moby commit ${MOBY_COMMIT}"
            cd ..
          else
            echo "Version $VERSION already in changelog"
          fi

          echo "Package version: $VERSION"
          echo "Moby commit: $MOBY_COMMIT"

      - name: Build package
        if: steps.check_release.outputs.has_new_release == 'true'
        run: |
          # Use -d to skip build dependency checks (we're packaging prebuilt binaries)
          # Use -a riscv64 to specify target architecture (building on amd64 host)
          dpkg-buildpackage -us -uc -b -d -a riscv64

      - name: Run lintian checks
        if: steps.check_release.outputs.has_new_release == 'true'
        run: |
          lintian --info --display-info ../*.deb || true

      - name: Package info
        if: steps.check_release.outputs.has_new_release == 'true'
        run: |
          for deb in ../*.deb; do
            echo "============================================"
            echo "=== Package: $(basename $deb) ==="
            echo "============================================"
            echo ""
            echo "=== Package Contents (first 30 files) ==="
            dpkg-deb --contents "$deb" | head -30
            echo ""
            echo "=== Package Info ==="
            dpkg-deb --info "$deb"
            echo ""
            echo "=== Package Size ==="
            ls -lh "$deb"
            echo ""
          done

      - name: Upload packages to release
        if: steps.check_release.outputs.has_new_release == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Use release tag from check_release step
          RELEASE_TAG="${{ steps.check_release.outputs.release_tag }}"

          echo "Uploading packages to release $RELEASE_TAG"
          echo ""

          for deb in ../*.deb; do
            echo "Uploading $(basename $deb)..."
            gh release upload $RELEASE_TAG "$deb" --clobber
          done

          echo ""
          echo "âœ… All Debian packages uploaded successfully!"
          echo ""
          echo "Packages built:"
          ls -lh ../*.deb
          echo ""
          echo "Install with:"
          echo "  # Download all packages"
          echo "  wget https://github.com/gounthar/docker-for-riscv64/releases/download/${RELEASE_TAG}/docker.io_*_riscv64.deb"
          echo "  wget https://github.com/gounthar/docker-for-riscv64/releases/download/${RELEASE_TAG}/containerd_*_riscv64.deb"
          echo "  wget https://github.com/gounthar/docker-for-riscv64/releases/download/${RELEASE_TAG}/runc_*_riscv64.deb"
          echo ""
          echo "  # Install in dependency order"
          echo "  sudo dpkg -i runc_*_riscv64.deb"
          echo "  sudo dpkg -i containerd_*_riscv64.deb"
          echo "  sudo dpkg -i docker.io_*_riscv64.deb"
          echo "  sudo apt-get install -f"
