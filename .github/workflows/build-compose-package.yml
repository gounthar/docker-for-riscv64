name: Build Docker Compose Debian Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Compose release tag'
        required: true
        default: 'compose-v2.40.1-riscv64'

jobs:
  build-deb:
    runs-on: [self-hosted, riscv64]
    if: startsWith(github.event.release.tag_name, 'compose-') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper dh-make dpkg-dev lintian

      - name: Download compose binary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name || github.event.inputs.release_tag }}"
          echo "Building package for release: $RELEASE_TAG"

          # Download binary
          gh release download $RELEASE_TAG -p docker-compose
          chmod +x docker-compose

          # Verify
          ./docker-compose version || echo "Version command not available yet"

          ls -lh docker-compose

      - name: Update package version in changelog
        run: |
          # Extract version from tag (compose-v2.40.1-riscv64 -> 2.40.1)
          RELEASE_TAG="${{ github.event.release.tag_name || github.event.inputs.release_tag }}"
          VERSION=$(echo $RELEASE_TAG | sed 's/^compose-v//; s/-riscv64$//')

          echo "Package version: $VERSION"

          # Update changelog with actual version
          sed -i "s/2.40.1/$VERSION/g" debian-compose/changelog

      - name: Build package
        run: |
          # Copy packaging files to debian/
          cp -r debian-compose debian

          # Build package
          dpkg-buildpackage -us -uc -b

          ls -lh ../*.deb

      - name: Run lintian checks
        run: |
          lintian --info --display-info ../*.deb || true

      - name: Package info
        run: |
          for deb in ../*.deb; do
            echo "============================================"
            echo "=== Package: $(basename $deb) ==="
            echo "============================================"
            echo ""
            echo "=== Package Contents ==="
            dpkg-deb --contents "$deb" | head -50
            echo ""
            echo "=== Package Info ==="
            dpkg-deb --info "$deb"
            echo ""
            echo "=== Package Size ==="
            ls -lh "$deb"
            echo ""
          done

      - name: Upload packages to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name || github.event.inputs.release_tag }}"

          echo "Uploading packages to release $RELEASE_TAG"
          echo ""

          for deb in ../*.deb; do
            echo "Uploading $(basename $deb)..."
            gh release upload $RELEASE_TAG "$deb" --clobber
          done

          echo ""
          echo "âœ… Docker Compose Debian package uploaded successfully!"
          echo ""
          echo "Packages built:"
          ls -lh ../*.deb
          echo ""
          echo "Install with:"
          echo "  wget https://github.com/gounthar/docker-for-riscv64/releases/download/${RELEASE_TAG}/docker-compose-plugin_*.deb"
          echo "  sudo dpkg -i docker-compose-plugin_*.deb"
          echo "  docker compose version"
